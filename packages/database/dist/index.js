"use strict";var e=require("react"),t=require("react-redux"),a=require("@reduxjs/toolkit"),r=require("@altanlabs/auth"),n=require("axios");const o=(e,t)=>{const a=e.tables.tables.byName[t];if(!a)throw new Error(`Table ${t} not found`);return a},l=a.createAsyncThunk("tables/fetchRecords",(async({tableName:e,queryParams:t={}},a)=>{let r;for(let n=0;n<3;n++)try{const r=o(a.getState(),e),{api:n}=a.extra,l=await n.post(`/table/${r}/record/query`,{filters:t.filters||[],sort:t.sort||[],limit:t.limit||100,page_token:t.pageToken,fields:t.fields,amount:t.amount||"all"});return{tableId:r,records:l.data.records,total:l.data.total,nextPageToken:l.data.next_page_token}}catch(e){if(r=e,n<2){await new Promise((e=>setTimeout(e,1e3*Math.pow(2,n))));continue}}return a.rejectWithValue(r instanceof Error?r.message:"Failed to fetch records")})),i=a.createAsyncThunk("tables/createRecord",(async({tableName:e,record:t},a)=>{try{const r=o(a.getState(),e),{api:n}=a.extra;return{tableId:r,record:(await n.post(`/table/${r}/record`,{records:[{fields:t}]})).data.records[0]}}catch(e){return a.rejectWithValue(e instanceof Error?e.message:"Failed to create record")}})),s=a.createAsyncThunk("tables/updateRecord",(async({tableName:e,recordId:t,updates:a},r)=>{const n=r.getState(),l=o(n,e),{api:i}=r.extra;return{tableId:l,record:(await i.patch(`/table/${l}/record/${t}`,{fields:a})).data.record}})),d=a.createAsyncThunk("tables/deleteRecord",(async({tableName:e,recordId:t},a)=>{const r=a.getState().tables.tables.byName[e];if(!r)throw new Error(`Table ${e} not found`);const{api:n}=a.extra;return await n.delete(`/table/${r}/record/${t}`),{tableId:r,recordId:t}})),c=a.createAsyncThunk("tables/fetchSchema",(async({tableName:e},t)=>{const a=t.getState().tables.tables.byName[e];if(!a)throw new Error(`Table ${e} not found`);const{api:r}=t.extra;return{tableId:a,schema:(await r.get(`/table/${a}`)).data.table}})),u=a.createAsyncThunk("tables/createRecords",(async({tableName:e,records:t},a)=>{try{const r=o(a.getState(),e),{api:n}=a.extra;return{tableId:r,records:(await n.post(`/table/${r}/record`,{records:t.map((e=>({fields:e})))})).data.records}}catch(e){return a.rejectWithValue(e instanceof Error?e.message:"Failed to create records")}})),b=a.createAsyncThunk("tables/deleteRecords",(async({tableName:e,recordIds:t},a)=>{const r=a.getState().tables.tables.byName[e];if(!r)throw new Error(`Table ${e} not found`);const{api:n}=a.extra;return await n.delete(`/table/${r}/record`,{data:{records:t}}),{tableId:r,recordIds:t}})),m=a.createSlice({name:"tables",initialState:{tables:{byId:{},byName:{},allIds:[]},schemas:{byTableId:{}},records:{byTableId:{}},loading:{tables:"idle",records:"idle",schemas:"idle"},error:null,initialized:{}},reducers:{initializeTables:(e,t)=>{const{SAMPLE_TABLES:a}=t.payload;Object.entries(a).forEach((([t,a])=>{e.tables.byId[a]={id:a,name:t},e.tables.byName[t]=a,e.tables.allIds.includes(a)||e.tables.allIds.push(a),e.initialized[a]=!1}))},clearTableData:(e,t)=>{const a=e.tables.byName[t.payload];a&&(delete e.records.byTableId[a],e.initialized[a]=!1)}},extraReducers:e=>{e.addCase(l.pending,(e=>{e.loading.records="loading",e.error=null})).addCase(l.fulfilled,((e,t)=>{const{tableId:a,records:r,total:n,nextPageToken:o}=t.payload;e.records.byTableId[a]={items:r,total:n,lastUpdated:(new Date).toISOString(),nextPageToken:o},e.loading.records="idle",e.initialized[a]=!0,e.error=null})).addCase(l.rejected,((e,t)=>{e.loading.records="error",e.error=t.payload||"An unknown error occurred"})).addCase(i.fulfilled,((e,t)=>{var a;const{tableId:r,record:n}=t.payload;(null===(a=e.records.byTableId[r])||void 0===a?void 0:a.items)&&e.records.byTableId[r].items.push(n)})).addCase(s.fulfilled,((e,t)=>{var a;const{tableId:r,record:n}=t.payload,o=null===(a=e.records.byTableId[r])||void 0===a?void 0:a.items;if(o){const e=o.findIndex((e=>e.id===n.id));-1!==e&&(o[e]=n)}})).addCase(d.fulfilled,((e,t)=>{var a;const{tableId:r,recordId:n}=t.payload,o=null===(a=e.records.byTableId[r])||void 0===a?void 0:a.items;o&&(e.records.byTableId[r].items=o.filter((e=>e.id!==n)))})).addCase(c.pending,(e=>{e.loading.schemas="loading"})).addCase(c.fulfilled,((e,t)=>{const{tableId:a,schema:r}=t.payload;e.schemas.byTableId[a]=r,e.loading.schemas="idle"})).addCase(c.rejected,((e,t)=>{e.loading.schemas="idle",e.error=t.error.message||null})).addCase(u.fulfilled,((e,t)=>{var a;const{tableId:r,records:n}=t.payload;(null===(a=e.records.byTableId[r])||void 0===a?void 0:a.items)&&e.records.byTableId[r].items.push(...n)})).addCase(b.fulfilled,((e,t)=>{var a;const{tableId:r,recordIds:n}=t.payload,o=null===(a=e.records.byTableId[r])||void 0===a?void 0:a.items;o&&(e.records.byTableId[r].items=o.filter((e=>!n.includes(e.id))))}))}}),{initializeTables:f,clearTableData:p}=m.actions;var y=m.reducer;const g=({message:t,onClose:a,config:r})=>{const[n,o]=e.useState(!1),l=(()=>{var e;if(t.includes("Invalid tables:"))return{ids:t.split("(")[0].replace("Invalid tables:","").trim(),names:(null===(e=t.split("table names:")[1])||void 0===e?void 0:e.replace(")","").trim())||""};const a=Object.entries(r.SAMPLE_TABLES).filter((([e,t])=>t.length>36||!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)));return a.length>0?{ids:a.map((([e,t])=>t)).join(", "),names:a.map((([e])=>e)).join(", ")}:null})(),i=`Database Configuration Error\n\nError Message: ${l?`Invalid tables: ${l.ids} (table names: ${l.names})`:t}\n\nConfiguration Details:\n${l?`- Invalid Table IDs: ${l.ids}`:""}\n- Table Names in Configuration: ${Object.keys(r.SAMPLE_TABLES).join(", ")}\n- Table IDs in Configuration: ${Object.values(r.SAMPLE_TABLES).join(", ")}\n\nPlease help me fix this database configuration issue in my Altan project. I need to correct the invalid table IDs in my configuration.\n\nAdditional Context:\n- This error occurred while validating table IDs in the Altan database configuration\n- The tables need to exist in the system before they can be used`;return e.createElement("div",{style:{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%)",backgroundColor:"#f44336",color:"white",padding:"15px",borderRadius:"5px",zIndex:1e3,boxShadow:"0 2px 10px rgba(0,0,0,0.2)",maxWidth:"500px",width:"90%"}},e.createElement("div",{style:{fontWeight:"bold",fontSize:"16px",marginBottom:"10px",borderBottom:"1px solid rgba(255,255,255,0.3)",paddingBottom:"5px"}},"Database Configuration Error"),e.createElement("div",{style:{marginBottom:"15px"}},l?`Configuration error: ${l.names} could not be found`:t),e.createElement("div",{style:{backgroundColor:"rgba(0,0,0,0.1)",padding:"10px",borderRadius:"4px",fontSize:"14px",marginBottom:"15px"}},e.createElement("strong",null,"Need help?"),' Click the "Copy Error" button below and paste it to the AI assistant in chat for troubleshooting assistance.'),e.createElement("div",{style:{display:"flex",justifyContent:"space-between"}},e.createElement("button",{onClick:()=>{navigator.clipboard.writeText(i).then((()=>{o(!0),setTimeout((()=>o(!1)),2e3)}))},style:{backgroundColor:n?"#4CAF50":"white",color:n?"white":"#f44336",border:"none",padding:"5px 10px",borderRadius:"3px",cursor:"pointer",transition:"all 0.3s ease"}},n?"Copied!":"Copy Error"),e.createElement("button",{onClick:a,style:{backgroundColor:"transparent",color:"white",border:"1px solid white",padding:"5px 10px",borderRadius:"3px",cursor:"pointer"}},"Close")))},h=n.create(),T={},v={},S=e.memo((({config:o,children:l,customMiddleware:i=[]})=>{const[s,d]=e.useState(null),[c,u]=e.useState(!0),b=e.useRef(o),[m,p]=e.useState(!1),S=r.useAuthAPI(!1),x=e.useMemo((()=>/^https:\/\/api\.altan\.ai\/galaxia\/hook\/.+/.test(o.API_BASE_URL)),[o.API_BASE_URL]);e.useEffect((()=>{if(b.current===o&&m)return;b.current=o;(async()=>{var e;u(!0);try{if(!x)return d("Invalid base URL format. URL must start with https://api.altan.ai/galaxia/hook/"),void u(!1);if(o.SAMPLE_TABLES){const t=Object.values(o.SAMPLE_TABLES),a=await(async e=>{try{const t=e.filter((e=>!T[e]));if(0===t.length)return{valid:!0};const a=t.join(","),r=`https://api.altan.ai/tables/table/ping?table_ids=${a}`,n=`ping_${a}`;if(v[n])return new Promise((e=>{const a=()=>{if(v[n])setTimeout(a,50);else{const a=t.every((e=>T[e]));e({valid:a})}};a()}));v[n]=!0;try{const e=await h.get(r);if(!e.data.all_valid){const t=e.data.invalid_tables||[];return(e.data.valid_tables||[]).forEach((e=>{T[e]=!0})),{valid:!1,invalidTables:t}}return t.forEach((e=>{T[e]=!0})),{valid:!0}}finally{v[n]=!1}}catch(e){return console.error("Table validation error:",e),{valid:!1}}})(t);if(!a.valid){let t;if(null===(e=a.invalidTables)||void 0===e?void 0:e.length){const e=Object.entries(o.SAMPLE_TABLES).filter((([e,t])=>{var r;return null===(r=a.invalidTables)||void 0===r?void 0:r.includes(t)})).map((([e])=>e)).join(", ");t=`Invalid tables: ${a.invalidTables.join(", ")} (table names: ${e})`}else t="One or more tables could not be found";return d(t),void u(!1)}}u(!1),p(!0)}catch(e){console.error("[DatabaseProvider] Validation error:",e),d(`Validation error: ${e instanceof Error?e.message:String(e)}`),u(!1)}})()}),[o,x]);const I=e.useMemo((()=>{if(s||c)return null;try{!function(e){for(const t of Object.values(e.SAMPLE_TABLES))if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t))throw new Error(`Table name "${t}" is not a valid UUID.`)}(o);const t=S?r.createAuthenticatedApi(o.API_BASE_URL):(e=o.API_BASE_URL,n.create({baseURL:e})),l=a.configureStore({reducer:{tables:y},middleware:e=>e({thunk:{extraArgument:{api:t}}}).concat(i)});return l.dispatch(f(o)),l}catch(e){return console.error("Store creation error:",e),d(`Configuration error: ${e instanceof Error?e.message:String(e)}`),null}var e}),[o,i,s,S,c]),E=()=>{d(null)};return c?null:s?e.createElement(e.Fragment,null,e.createElement(g,{message:s,onClose:E,config:o}),e.createElement("div",null,"Unable to initialize database due to configuration errors.")):I?e.createElement(t.Provider,{store:I},l):e.createElement("div",null,"Failed to initialize database store.")}));S.displayName="DatabaseProvider";var x,I,E,w;function C(e,t){try{const a=e instanceof Date?e:new Date(String(e));return t?a.toLocaleString():a.toLocaleDateString()}catch(t){return String(e)}}function N(e){return Boolean(e)?"Yes":"No"}function A(e,t){try{const a=Number(e);return isNaN(a)?String(e):void 0!==t.decimals?a.toFixed(t.decimals):String(a)}catch(t){return String(e)}}function k(e,t){try{const a=Number(e);return isNaN(a)?String(e):new Intl.NumberFormat(t.locale||"en-US",{style:"currency",currency:t.currency||"USD"}).format(a)}catch(t){return String(e)}}function L(e,t){try{const a=Number(e);return isNaN(a)?String(e):`${(100*a).toFixed(t.decimals||0)}%`}catch(t){return String(e)}}function $(e){try{const t=Number(e);if(isNaN(t))return String(e);const a=Math.floor(t/36e5),r=Math.floor(t%36e5/6e4);return`${a}h ${r}m ${Math.floor(t%6e4/1e3)}s`}catch(t){return String(e)}}function P(e){return Array.isArray(e)?e.join(", "):String(e)}function R(e){try{return JSON.stringify(e,null,2)}catch(t){return String(e)}}exports.FieldType=void 0,(x=exports.FieldType||(exports.FieldType={})).SingleLineText="singleLineText",x.MultiLineText="multiLineText",x.Select="select",x.LongText="longText",x.Number="number",x.SingleSelect="singleSelect",x.MultiSelect="multiSelect",x.Date="date",x.DateTime="dateTime",x.Checkbox="checkbox",x.User="user",x.Attachment="attachment",x.Reference="reference",x.Email="email",x.Phone="phone",x.URL="url",x.Duration="duration",x.Rating="rating",x.Formula="formula",x.Rollup="rollup",x.Count="count",x.Lookup="lookup",x.Currency="currency",x.Percent="percent",x.ForeignKey="foreignKey",x.JSON="json",x.Trigger="trigger",a.configureStore({reducer:{tables:y},middleware:e=>e({thunk:{extraArgument:{}}})}),function(e){e.Local="Local",e.Friendly="Friendly",e.US="US",e.European="European",e.ISO="ISO"}(I||(I={})),function(e){e.TwelveHour="12 hour",e.TwentyFourHour="24 hour"}(E||(E={})),function(e){e.GMT_UTC="GMT/UTC",e.Local="local"}(w||(w={}));const D={formatFieldValue:function(e,t){if(null==e)return"";if(null==t?void 0:t.type)switch(t.type){case exports.FieldType.Date:return C(e,!1);case exports.FieldType.DateTime:return C(e,!0);case exports.FieldType.Checkbox:return N(e);case exports.FieldType.Number:return A(e,t);case exports.FieldType.Currency:return k(e,t);case exports.FieldType.Percent:return L(e,t);case exports.FieldType.Duration:return $(e);case exports.FieldType.MultiSelect:return P(e);case exports.FieldType.JSON:case exports.FieldType.User:case exports.FieldType.Attachment:return R(e);default:return String(e)}return e instanceof Date?C(e,!0):"object"==typeof e?JSON.stringify(e):String(e)},formatDateValue:C,formatBooleanValue:N,formatNumberValue:A,formatCurrencyValue:k,formatPercentValue:L,formatDurationValue:$,formatMultiSelectValue:P,formatJSONValue:R};exports.DatabaseProvider=S,exports.fieldHelpers=D,exports.useDatabase=function(a,r){const n=e.useRef(!0),o=t.useDispatch(),[m,f]=e.useState(null),p=e.useRef({}),y=t.useSelector((e=>((e,t)=>{const a=e.tables.tables.byName[t];if(!a)return null;const r=e.tables.records.byTableId[a];return{records:(null==r?void 0:r.items)||[],total:(null==r?void 0:r.total)||0,schema:e.tables.schemas.byTableId[a],initialized:e.tables.initialized[a],nextPageToken:null==r?void 0:r.nextPageToken,lastUpdated:null==r?void 0:r.lastUpdated}})(e,a))),g=t.useSelector((e=>"loading"===e.tables.loading.records)),h=t.useSelector((e=>"loading"===e.tables.loading.schemas)),T=t.useSelector((e=>e.tables.error)),v=(null==y?void 0:y.records)||[],S=(null==y?void 0:y.schema)||null,x=(null==y?void 0:y.initialized)||!1,I=(null==y?void 0:y.lastUpdated)||null,E=e.useMemo((()=>r||{limit:100}),[r]),w=e.useCallback((async(e,t)=>{try{return await o(e).unwrap()}catch(e){null==t||t(e)}}),[o]);e.useEffect((()=>{if(!a||T||!1===E.enabled)return;const e=`schema_${a}`,t=`records_${a}`;S||h||p.current[e]||(p.current[e]=!0,w(c({tableName:a})).finally((()=>{n.current&&(p.current[e]=!1)}))),x||g||p.current[t]||(p.current[t]=!0,w(l({tableName:a,queryParams:E})).finally((()=>{n.current&&(p.current[t]=!1)})))}),[a,S,E,w]);const C=e.useCallback((async(e={limit:20},t)=>{var r;if(!g){const o=await w(l({tableName:a,queryParams:e}),t);o&&n.current&&f(null!==(r=o.nextPageToken)&&void 0!==r?r:null)}}),[a,w,g]),N=e.useCallback((async(e,t)=>{const r=await w(i({tableName:a,record:e}),t);return null==r?void 0:r.record}),[a,w]),A=e.useCallback((async(e,t,r)=>await w(s({tableName:a,recordId:e,updates:t}),r)),[a,w]),k=e.useCallback((async(e,t)=>{await w(d({tableName:a,recordId:e}),t)}),[a,w]),L=e.useCallback((async(e,t)=>{const r=await w(u({tableName:a,records:e}),t);return null==r?void 0:r.records}),[a,w]),$=e.useCallback((async(e,t)=>{await w(b({tableName:a,recordIds:e}),t)}),[a,w]),P=e.useCallback((async e=>{m&&!g&&await C({pageToken:m,limit:20},e)}),[m,g]);return e.useEffect((()=>()=>{n.current=!1}),[]),e.useMemo((()=>({records:v,schema:S,isLoading:g,schemaLoading:h,error:T,nextPageToken:m,lastUpdated:I,refresh:C,fetchNextPage:P,addRecord:N,modifyRecord:A,removeRecord:k,addRecords:L,removeRecords:$})),[v,S,g,h,T,m,I,C,a,o,N,A,k,L,$,P])};
//# sourceMappingURL=index.js.map
