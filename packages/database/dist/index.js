import e,{useState as t,memo as a,useRef as r,useMemo as n,useEffect as o,useCallback as l}from"react";import{Provider as i,useDispatch as s,useSelector as d}from"react-redux";import{createAsyncThunk as c,createSlice as u,configureStore as b}from"@reduxjs/toolkit";import{useAuthAPI as m}from"@altanlabs/auth";import f from"axios";const g=(e,t)=>{const a=e.tables.tables.byName[t];if(!a)throw new Error(`Table ${t} not found`);return a},p=c("tables/fetchRecords",(async({tableName:e,queryParams:t={}},a)=>{let r;for(let n=0;n<3;n++)try{const r=g(a.getState(),e),{api:n}=a.extra,o=await n.post(`/table/${r}/record/query`,{filters:t.filters||[],sort:t.sort||[],limit:t.limit||100,page_token:t.pageToken,fields:t.fields,amount:t.amount||"all"});return{tableId:r,records:o.data.records,total:o.data.total,nextPageToken:o.data.next_page_token}}catch(e){if(r=e,n<2){await new Promise((e=>setTimeout(e,1e3*Math.pow(2,n))));continue}}return a.rejectWithValue(r instanceof Error?r.message:"Failed to fetch records")})),y=c("tables/createRecord",(async({tableName:e,record:t},a)=>{try{const r=g(a.getState(),e),{api:n}=a.extra;return{tableId:r,record:(await n.post(`/table/${r}/record`,{records:[{fields:t}]})).data.records[0]}}catch(e){return a.rejectWithValue(e instanceof Error?e.message:"Failed to create record")}})),h=c("tables/updateRecord",(async({tableName:e,recordId:t,updates:a},r)=>{const n=r.getState(),o=g(n,e),{api:l}=r.extra;return{tableId:o,record:(await l.patch(`/table/${o}/record/${t}`,{fields:a})).data.record}})),v=c("tables/deleteRecord",(async({tableName:e,recordId:t},a)=>{const r=a.getState().tables.tables.byName[e];if(!r)throw new Error(`Table ${e} not found`);const{api:n}=a.extra;return await n.delete(`/table/${r}/record/${t}`),{tableId:r,recordId:t}})),S=c("tables/fetchSchema",(async({tableName:e},t)=>{const a=t.getState().tables.tables.byName[e];if(!a)throw new Error(`Table ${e} not found`);const{api:r}=t.extra;return{tableId:a,schema:(await r.get(`/table/${a}`)).data.table}})),T=c("tables/createRecords",(async({tableName:e,records:t},a)=>{try{const r=g(a.getState(),e),{api:n}=a.extra;return{tableId:r,records:(await n.post(`/table/${r}/record`,{records:t.map((e=>({fields:e})))})).data.records}}catch(e){return a.rejectWithValue(e instanceof Error?e.message:"Failed to create records")}})),x=c("tables/deleteRecords",(async({tableName:e,recordIds:t},a)=>{const r=a.getState().tables.tables.byName[e];if(!r)throw new Error(`Table ${e} not found`);const{api:n}=a.extra;return await n.delete(`/table/${r}/record`,{data:{records:t}}),{tableId:r,recordIds:t}})),I=u({name:"tables",initialState:{tables:{byId:{},byName:{},allIds:[]},schemas:{byTableId:{}},records:{byTableId:{}},loading:{tables:"idle",records:"idle",schemas:"idle"},error:null,initialized:{}},reducers:{initializeTables:(e,t)=>{const{SAMPLE_TABLES:a}=t.payload;Object.entries(a).forEach((([t,a])=>{e.tables.byId[a]={id:a,name:t},e.tables.byName[t]=a,e.tables.allIds.includes(a)||e.tables.allIds.push(a),e.initialized[a]=!1}))},clearTableData:(e,t)=>{const a=e.tables.byName[t.payload];a&&(delete e.records.byTableId[a],e.initialized[a]=!1)}},extraReducers:e=>{e.addCase(p.pending,(e=>{e.loading.records="loading",e.error=null})).addCase(p.fulfilled,((e,t)=>{const{tableId:a,records:r,total:n,nextPageToken:o}=t.payload;e.records.byTableId[a]={items:r,total:n,lastUpdated:(new Date).toISOString(),nextPageToken:o},e.loading.records="idle",e.initialized[a]=!0,e.error=null})).addCase(p.rejected,((e,t)=>{e.loading.records="error",e.error=t.payload||"An unknown error occurred"})).addCase(y.fulfilled,((e,t)=>{var a;const{tableId:r,record:n}=t.payload;(null===(a=e.records.byTableId[r])||void 0===a?void 0:a.items)&&e.records.byTableId[r].items.push(n)})).addCase(h.fulfilled,((e,t)=>{var a;const{tableId:r,record:n}=t.payload,o=null===(a=e.records.byTableId[r])||void 0===a?void 0:a.items;if(o){const e=o.findIndex((e=>e.id===n.id));-1!==e&&(o[e]=n)}})).addCase(v.fulfilled,((e,t)=>{var a;const{tableId:r,recordId:n}=t.payload,o=null===(a=e.records.byTableId[r])||void 0===a?void 0:a.items;o&&(e.records.byTableId[r].items=o.filter((e=>e.id!==n)))})).addCase(S.pending,(e=>{e.loading.schemas="loading"})).addCase(S.fulfilled,((e,t)=>{const{tableId:a,schema:r}=t.payload;e.schemas.byTableId[a]=r,e.loading.schemas="idle"})).addCase(S.rejected,((e,t)=>{e.loading.schemas="idle",e.error=t.error.message||null})).addCase(T.fulfilled,((e,t)=>{var a;const{tableId:r,records:n}=t.payload;(null===(a=e.records.byTableId[r])||void 0===a?void 0:a.items)&&e.records.byTableId[r].items.push(...n)})).addCase(x.fulfilled,((e,t)=>{var a;const{tableId:r,recordIds:n}=t.payload,o=null===(a=e.records.byTableId[r])||void 0===a?void 0:a.items;o&&(e.records.byTableId[r].items=o.filter((e=>!n.includes(e.id))))}))}}),{initializeTables:w,clearTableData:E}=I.actions;var N=I.reducer;const C=({message:a,onClose:r,config:n})=>{const[o,l]=t(!1),i=(()=>{var e;if(a.includes("Invalid tables:"))return{ids:a.split("(")[0].replace("Invalid tables:","").trim(),names:(null===(e=a.split("table names:")[1])||void 0===e?void 0:e.replace(")","").trim())||""};const t=Object.entries(n.SAMPLE_TABLES).filter((([e,t])=>t.length>36||!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)));return t.length>0?{ids:t.map((([e,t])=>t)).join(", "),names:t.map((([e])=>e)).join(", ")}:null})(),s=`Database Configuration Error\n\nError Message: ${i?`Invalid tables: ${i.ids} (table names: ${i.names})`:a}\n\nConfiguration Details:\n${i?`- Invalid Table IDs: ${i.ids}`:""}\n- Table Names in Configuration: ${Object.keys(n.SAMPLE_TABLES).join(", ")}\n- Table IDs in Configuration: ${Object.values(n.SAMPLE_TABLES).join(", ")}\n\nPlease help me fix this database configuration issue in my Altan project. I need to correct the invalid table IDs in my configuration.\n\nAdditional Context:\n- This error occurred while validating table IDs in the Altan database configuration\n- The tables need to exist in the system before they can be used`;return e.createElement("div",{style:{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%)",backgroundColor:"#f44336",color:"white",padding:"15px",borderRadius:"5px",zIndex:1e3,boxShadow:"0 2px 10px rgba(0,0,0,0.2)",maxWidth:"500px",width:"90%"}},e.createElement("div",{style:{fontWeight:"bold",fontSize:"16px",marginBottom:"10px",borderBottom:"1px solid rgba(255,255,255,0.3)",paddingBottom:"5px"}},"Database Configuration Error"),e.createElement("div",{style:{marginBottom:"15px"}},i?`Configuration error: ${i.names} could not be found`:a),e.createElement("div",{style:{backgroundColor:"rgba(0,0,0,0.1)",padding:"10px",borderRadius:"4px",fontSize:"14px",marginBottom:"15px"}},e.createElement("strong",null,"Need help?"),' Click the "Copy Error" button below and paste it to the AI assistant in chat for troubleshooting assistance.'),e.createElement("div",{style:{display:"flex",justifyContent:"space-between"}},e.createElement("button",{onClick:()=>{navigator.clipboard.writeText(s).then((()=>{l(!0),setTimeout((()=>l(!1)),2e3)}))},style:{backgroundColor:o?"#4CAF50":"white",color:o?"white":"#f44336",border:"none",padding:"5px 10px",borderRadius:"3px",cursor:"pointer",transition:"all 0.3s ease"}},o?"Copied!":"Copy Error"),e.createElement("button",{onClick:r,style:{backgroundColor:"transparent",color:"white",border:"1px solid white",padding:"5px 10px",borderRadius:"3px",cursor:"pointer"}},"Close")))},L=f.create(),$={},A={},P=a((({config:a,children:l,customMiddleware:s=[]})=>{const[d,c]=t(null),[u,g]=t(!0),p=r(a),[y,h]=t(!1),v=m(!1),S=n((()=>/^https:\/\/api\.altan\.ai\/galaxia\/hook\/.+/.test(a.API_BASE_URL)),[a.API_BASE_URL]);o((()=>{if(p.current===a&&y)return;p.current=a;(async()=>{var e;g(!0);try{if(!S)return c("Invalid base URL format. URL must start with https://api.altan.ai/galaxia/hook/"),void g(!1);if(a.SAMPLE_TABLES){const t=Object.values(a.SAMPLE_TABLES),r=await(async e=>{try{const t=e.filter((e=>!$[e]));if(0===t.length)return{valid:!0};const a=t.join(","),r=`https://api.altan.ai/tables/table/ping?table_ids=${a}`,n=`ping_${a}`;if(A[n])return new Promise((e=>{const a=()=>{if(A[n])setTimeout(a,50);else{const a=t.every((e=>$[e]));e({valid:a})}};a()}));A[n]=!0;try{const e=await L.get(r);if(!e.data.all_valid){const t=e.data.invalid_tables||[];return(e.data.valid_tables||[]).forEach((e=>{$[e]=!0})),{valid:!1,invalidTables:t}}return t.forEach((e=>{$[e]=!0})),{valid:!0}}finally{A[n]=!1}}catch(e){return console.error("Table validation error:",e),{valid:!1}}})(t);if(!r.valid){let t;if(null===(e=r.invalidTables)||void 0===e?void 0:e.length){const e=Object.entries(a.SAMPLE_TABLES).filter((([e,t])=>{var a;return null===(a=r.invalidTables)||void 0===a?void 0:a.includes(t)})).map((([e])=>e)).join(", ");t=`Invalid tables: ${r.invalidTables.join(", ")} (table names: ${e})`}else t="One or more tables could not be found";return c(t),void g(!1)}}g(!1),h(!0)}catch(e){console.error("[DatabaseProvider] Validation error:",e),c(`Validation error: ${e instanceof Error?e.message:String(e)}`),g(!1)}})()}),[a,S]);const T=n((()=>{if(d||u)return null;try{!function(e){for(const t of Object.values(e.SAMPLE_TABLES))if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t))throw new Error(`Table name "${t}" is not a valid UUID.`)}(a);const t=null!=v?v:(e=a.API_BASE_URL,f.create({baseURL:e})),r=b({reducer:{tables:N},middleware:e=>e({thunk:{extraArgument:{api:t}}}).concat(s)});return r.dispatch(w(a)),r}catch(e){return console.error("Store creation error:",e),c(`Configuration error: ${e instanceof Error?e.message:String(e)}`),null}var e}),[a,s,d,v,u]),x=()=>{c(null)};return u?null:d?e.createElement(e.Fragment,null,e.createElement(C,{message:d,onClose:x,config:a}),e.createElement("div",null,"Unable to initialize database due to configuration errors.")):T?e.createElement(i,{store:T},l):e.createElement("div",null,"Failed to initialize database store.")}));P.displayName="DatabaseProvider";function k(e,a){const i=r(!0),c=s(),[u,b]=t(null),m=r({}),f=d((t=>((e,t)=>{const a=e.tables.tables.byName[t];if(!a)return null;const r=e.tables.records.byTableId[a];return{records:(null==r?void 0:r.items)||[],total:(null==r?void 0:r.total)||0,schema:e.tables.schemas.byTableId[a],initialized:e.tables.initialized[a],nextPageToken:null==r?void 0:r.nextPageToken,lastUpdated:null==r?void 0:r.lastUpdated}})(t,e))),g=d((e=>"loading"===e.tables.loading.records)),I=d((e=>"loading"===e.tables.loading.schemas)),w=d((e=>e.tables.error)),{records:E,schema:N,initialized:C,lastUpdated:L}=n((()=>({records:(null==f?void 0:f.records)||[],schema:(null==f?void 0:f.schema)||null,initialized:(null==f?void 0:f.initialized)||!1,lastUpdated:(null==f?void 0:f.lastUpdated)||null})),[f]);o((()=>()=>{i.current=!1}),[]);const $=n((()=>a||{limit:100}),[a]),A=l((async(e,t)=>{try{const t=await c(e).unwrap();if(console.log("@safeDispatch: result",i.current,t),i.current)return t}catch(e){null==t||t(e)}}),[c]);o((()=>{if(!e||w)return;const t=`schema_${e}`,a=`records_${e}`;N||I||m.current[t]||(m.current[t]=!0,A(S({tableName:e})).finally((()=>{i.current&&(m.current[t]=!1)}))),C||g||m.current[a]||(m.current[a]=!0,A(p({tableName:e,queryParams:$})).finally((()=>{i.current&&(m.current[a]=!1)})))}),[e,N,$,A]);const P=l((async(t={limit:20},a)=>{var r;if(!g){const n=await A(p({tableName:e,queryParams:t}),a);n&&i.current&&b(null!==(r=n.nextPageToken)&&void 0!==r?r:null)}}),[e,A,g]),k=l((async(t,a)=>await A(y({tableName:e,record:t}),a)),[e,A]),D=l((async(t,a,r)=>await A(h({tableName:e,recordId:t,updates:a}),r)),[e,A]),R=l((async(t,a)=>{await A(v({tableName:e,recordId:t}),a)}),[e,A]),j=l((async(t,a)=>await A(T({tableName:e,records:t}),a)),[e,A]),U=l((async(t,a)=>{await A(x({tableName:e,recordIds:t}),a)}),[e,A]);return n((()=>({records:E,schema:N,isLoading:g,schemaLoading:I,error:w,nextPageToken:u,lastUpdated:L,refresh:P,fetchNextPage:async e=>{u&&!g&&await P({pageToken:u,limit:20},e)},addRecord:k,modifyRecord:D,removeRecord:R,addRecords:j,removeRecords:U})),[E,N,g,I,w,u,L,P,e,c,k,D,R,j,U])}var D,R,j,U;function _(e,t){try{const a=e instanceof Date?e:new Date(String(e));return t?a.toLocaleString():a.toLocaleDateString()}catch(t){return String(e)}}function M(e){return Boolean(e)?"Yes":"No"}function B(e,t){try{const a=Number(e);return isNaN(a)?String(e):void 0!==t.decimals?a.toFixed(t.decimals):String(a)}catch(t){return String(e)}}function z(e,t){try{const a=Number(e);return isNaN(a)?String(e):new Intl.NumberFormat(t.locale||"en-US",{style:"currency",currency:t.currency||"USD"}).format(a)}catch(t){return String(e)}}function O(e,t){try{const a=Number(e);return isNaN(a)?String(e):`${(100*a).toFixed(t.decimals||0)}%`}catch(t){return String(e)}}function F(e){try{const t=Number(e);if(isNaN(t))return String(e);const a=Math.floor(t/36e5),r=Math.floor(t%36e5/6e4);return`${a}h ${r}m ${Math.floor(t%6e4/1e3)}s`}catch(t){return String(e)}}function V(e){return Array.isArray(e)?e.join(", "):String(e)}function J(e){try{return JSON.stringify(e,null,2)}catch(t){return String(e)}}!function(e){e.SingleLineText="singleLineText",e.MultiLineText="multiLineText",e.Select="select",e.LongText="longText",e.Number="number",e.SingleSelect="singleSelect",e.MultiSelect="multiSelect",e.Date="date",e.DateTime="dateTime",e.Checkbox="checkbox",e.User="user",e.Attachment="attachment",e.Reference="reference",e.Email="email",e.Phone="phone",e.URL="url",e.Duration="duration",e.Rating="rating",e.Formula="formula",e.Rollup="rollup",e.Count="count",e.Lookup="lookup",e.Currency="currency",e.Percent="percent",e.ForeignKey="foreignKey",e.JSON="json",e.Trigger="trigger"}(D||(D={})),b({reducer:{tables:N},middleware:e=>e({thunk:{extraArgument:{}}})}),function(e){e.Local="Local",e.Friendly="Friendly",e.US="US",e.European="European",e.ISO="ISO"}(R||(R={})),function(e){e.TwelveHour="12 hour",e.TwentyFourHour="24 hour"}(j||(j={})),function(e){e.GMT_UTC="GMT/UTC",e.Local="local"}(U||(U={}));const W={formatFieldValue:function(e,t){if(null==e)return"";if(null==t?void 0:t.type)switch(t.type){case D.Date:return _(e,!1);case D.DateTime:return _(e,!0);case D.Checkbox:return M(e);case D.Number:return B(e,t);case D.Currency:return z(e,t);case D.Percent:return O(e,t);case D.Duration:return F(e);case D.MultiSelect:return V(e);case D.JSON:case D.User:case D.Attachment:return J(e);default:return String(e)}return e instanceof Date?_(e,!0):"object"==typeof e?JSON.stringify(e):String(e)},formatDateValue:_,formatBooleanValue:M,formatNumberValue:B,formatCurrencyValue:z,formatPercentValue:O,formatDurationValue:F,formatMultiSelectValue:V,formatJSONValue:J};export{P as DatabaseProvider,D as FieldType,W as fieldHelpers,k as useDatabase};
//# sourceMappingURL=index.js.map
