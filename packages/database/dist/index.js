"use strict";var e=require("react"),t=require("react-redux"),r=require("@reduxjs/toolkit"),a=require("@altanlabs/auth"),o=require("axios");const n=(e,t)=>{const r=e.tables.tables.byName[t];if(!r)throw new Error(`Table ${t} not found`);return r},l=r.createAsyncThunk("tables/fetchRecords",(async({tableName:e,queryParams:t={}},r)=>{let a;for(let o=0;o<3;o++)try{const a=n(r.getState(),e),{api:o}=r.extra,l=await o.post(`/table/${a}/record/query`,{filters:t.filters||[],sort:t.sort||[],limit:t.limit||100,page_token:t.pageToken,fields:t.fields,amount:t.amount||"all"});return{tableId:a,records:l.data.records,total:l.data.total,nextPageToken:l.data.next_page_token}}catch(e){if(a=e,o<2){await new Promise((e=>setTimeout(e,1e3*Math.pow(2,o))));continue}}return r.rejectWithValue(a instanceof Error?a.message:"Failed to fetch records")})),i=r.createAsyncThunk("tables/createRecord",(async({tableName:e,record:t},r)=>{try{const a=n(r.getState(),e),{api:o}=r.extra;return{tableId:a,record:(await o.post(`/table/${a}/record`,{records:[{fields:t}]})).data.records[0]}}catch(e){return r.rejectWithValue(e instanceof Error?e.message:"Failed to create record")}})),d=r.createAsyncThunk("tables/updateRecord",(async({tableName:e,recordId:t,updates:r},a)=>{const o=a.getState(),l=n(o,e),{api:i}=a.extra;return{tableId:l,record:(await i.patch(`/table/${l}/record/${t}`,{fields:r})).data.record}})),s=r.createAsyncThunk("tables/deleteRecord",(async({tableName:e,recordId:t},r)=>{const a=r.getState().tables.tables.byName[e];if(!a)throw new Error(`Table ${e} not found`);const{api:o}=r.extra;return await o.delete(`/table/${a}/record/${t}`),{tableId:a,recordId:t}})),c=r.createAsyncThunk("tables/fetchSchema",(async({tableName:e},t)=>{const r=t.getState().tables.tables.byName[e];if(!r)throw new Error(`Table ${e} not found`);const{api:a}=t.extra;return{tableId:r,schema:(await a.get(`/table/${r}`)).data.table}})),u=r.createAsyncThunk("tables/createRecords",(async({tableName:e,records:t},r)=>{try{const a=n(r.getState(),e),{api:o}=r.extra;return{tableId:a,records:(await o.post(`/table/${a}/record`,{records:t.map((e=>({fields:e})))})).data.records}}catch(e){return r.rejectWithValue(e instanceof Error?e.message:"Failed to create records")}})),b=r.createAsyncThunk("tables/deleteRecords",(async({tableName:e,recordIds:t},r)=>{const a=r.getState().tables.tables.byName[e];if(!a)throw new Error(`Table ${e} not found`);const{api:o}=r.extra;return await o.delete(`/table/${a}/record`,{data:{records:t}}),{tableId:a,recordIds:t}})),m=r.createSlice({name:"tables",initialState:{tables:{byId:{},byName:{},allIds:[]},schemas:{byTableId:{}},records:{byTableId:{}},loading:{tables:"idle",records:"idle",schemas:"idle"},error:null,initialized:{}},reducers:{initializeTables:(e,t)=>{const{SAMPLE_TABLES:r}=t.payload;Object.entries(r).forEach((([t,r])=>{e.tables.byId[r]={id:parseInt(r),name:t},e.tables.byName[t]=r,e.tables.allIds.includes(r)||e.tables.allIds.push(r),e.initialized[r]=!1}))},clearTableData:(e,t)=>{const r=e.tables.byName[t.payload];r&&(delete e.records.byTableId[r],e.initialized[r]=!1)},optimisticAddRecord:(e,t)=>{var r;const{tableId:a,record:o}=t.payload;(null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items)&&e.records.byTableId[a].items.push(o)},optimisticUpdateRecord:(e,t)=>{var r;const{tableId:a,recordId:o,updates:n}=t.payload,l=null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items;if(l){const e=l.findIndex((e=>e.id===o));-1!==e&&(l[e]={...l[e],...n})}},optimisticDeleteRecord:(e,t)=>{var r;const{tableId:a,recordId:o}=t.payload,n=null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items;n&&(e.records.byTableId[a].items=n.filter((e=>e.id!==o)))},optimisticAddRecords:(e,t)=>{var r;const{tableId:a,records:o}=t.payload;(null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items)&&e.records.byTableId[a].items.push(...o)},optimisticDeleteRecords:(e,t)=>{var r;const{tableId:a,recordIds:o}=t.payload,n=null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items;n&&(e.records.byTableId[a].items=n.filter((e=>!o.includes(e.id))))},rollbackAddRecord:(e,t)=>{var r;const{tableId:a,tempId:o}=t.payload,n=null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items;n&&(e.records.byTableId[a].items=n.filter((e=>e.id!==o)))},rollbackUpdateRecord:(e,t)=>{var r;const{tableId:a,recordId:o,originalRecord:n}=t.payload,l=null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items;if(l){const e=l.findIndex((e=>e.id===o));-1!==e&&(l[e]=n)}}},extraReducers:e=>{e.addCase(l.pending,(e=>{e.loading.records="loading",e.error=null})).addCase(l.fulfilled,((e,t)=>{const{tableId:r,records:a,total:o,nextPageToken:n}=t.payload;e.records.byTableId[r]={items:a,total:o,lastUpdated:(new Date).toISOString(),nextPageToken:n},e.loading.records="idle",e.initialized[r]=!0,e.error=null})).addCase(l.rejected,((e,t)=>{e.loading.records="error",e.error=t.payload||"An unknown error occurred"})).addCase(i.fulfilled,((e,t)=>{var r;const{tableId:a,record:o}=t.payload;(null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items)&&e.records.byTableId[a].items.push(o)})).addCase(d.fulfilled,((e,t)=>{var r;const{tableId:a,record:o}=t.payload,n=null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items;if(n){const e=n.findIndex((e=>e.id===o.id));-1!==e&&(n[e]=o)}})).addCase(s.fulfilled,((e,t)=>{var r;const{tableId:a,recordId:o}=t.payload,n=null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items;n&&(e.records.byTableId[a].items=n.filter((e=>e.id!==o)))})).addCase(c.pending,(e=>{e.loading.schemas="loading"})).addCase(c.fulfilled,((e,t)=>{const{tableId:r,schema:a}=t.payload;e.schemas.byTableId[r]=a,e.loading.schemas="idle"})).addCase(c.rejected,((e,t)=>{e.loading.schemas="idle",e.error=t.error.message||null})).addCase(u.fulfilled,((e,t)=>{var r;const{tableId:a,records:o}=t.payload;(null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items)&&e.records.byTableId[a].items.push(...o)})).addCase(b.fulfilled,((e,t)=>{var r;const{tableId:a,recordIds:o}=t.payload,n=null===(r=e.records.byTableId[a])||void 0===r?void 0:r.items;n&&(e.records.byTableId[a].items=n.filter((e=>!o.includes(e.id))))}))}}),{initializeTables:f,clearTableData:p,optimisticAddRecord:y,optimisticUpdateRecord:h,optimisticDeleteRecord:g,optimisticAddRecords:I,optimisticDeleteRecords:T,rollbackAddRecord:v,rollbackUpdateRecord:S}=m.actions;var x=m.reducer;const w=({message:t,onClose:r,config:a})=>{const[o,n]=e.useState(!1),l=(()=>{var e;if(t.includes("Invalid tables:"))return{ids:t.split("(")[0].replace("Invalid tables:","").trim(),names:(null===(e=t.split("table names:")[1])||void 0===e?void 0:e.replace(")","").trim())||""};const r=Object.entries(a.SAMPLE_TABLES).filter((([e,t])=>t.length>36||!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)));return r.length>0?{ids:r.map((([e,t])=>t)).join(", "),names:r.map((([e])=>e)).join(", ")}:null})(),i=`Database Configuration Error\n\nError Message: ${l?`Invalid tables: ${l.ids} (table names: ${l.names})`:t}\n\nConfiguration Details:\n${l?`- Invalid Table IDs: ${l.ids}`:""}\n- Table Names in Configuration: ${Object.keys(a.SAMPLE_TABLES).join(", ")}\n- Table IDs in Configuration: ${Object.values(a.SAMPLE_TABLES).join(", ")}\n\nPlease help me fix this database configuration issue in my Altan project. I need to correct the invalid table IDs in my configuration.\n\nAdditional Context:\n- This error occurred while validating table IDs in the Altan database configuration\n- The tables need to exist in the system before they can be used`;return e.createElement("div",{style:{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%)",backgroundColor:"#f44336",color:"white",padding:"15px",borderRadius:"5px",zIndex:1e3,boxShadow:"0 2px 10px rgba(0,0,0,0.2)",maxWidth:"500px",width:"90%"}},e.createElement("div",{style:{fontWeight:"bold",fontSize:"16px",marginBottom:"10px",borderBottom:"1px solid rgba(255,255,255,0.3)",paddingBottom:"5px"}},"Database Configuration Error"),e.createElement("div",{style:{marginBottom:"15px"}},l?`Configuration error: ${l.names} could not be found`:t),e.createElement("div",{style:{backgroundColor:"rgba(0,0,0,0.1)",padding:"10px",borderRadius:"4px",fontSize:"14px",marginBottom:"15px"}},e.createElement("strong",null,"Need help?"),' Click the "Copy Error" button below and paste it to the AI assistant in chat for troubleshooting assistance.'),e.createElement("div",{style:{display:"flex",justifyContent:"space-between"}},e.createElement("button",{onClick:()=>{navigator.clipboard.writeText(i).then((()=>{n(!0),setTimeout((()=>n(!1)),2e3)}))},style:{backgroundColor:o?"#4CAF50":"white",color:o?"white":"#f44336",border:"none",padding:"5px 10px",borderRadius:"3px",cursor:"pointer",transition:"all 0.3s ease"}},o?"Copied!":"Copy Error"),e.createElement("button",{onClick:r,style:{backgroundColor:"transparent",color:"white",border:"1px solid white",padding:"5px 10px",borderRadius:"3px",cursor:"pointer"}},"Close")))},E=o.create(),N={},A={},C=e.memo((({config:n,children:l,customMiddleware:i=[]})=>{const[d,s]=e.useState(null),[c,u]=e.useState(!0),b=e.useRef(n),[m,p]=e.useState(!1),y=a.useAuthAPI(!1),h=e.useMemo((()=>/^https:\/\/api\.altan\.ai\/galaxia\/hook\/.+/.test(n.API_BASE_URL)),[n.API_BASE_URL]);e.useEffect((()=>{if(b.current===n&&m)return;b.current=n;(async()=>{var e;u(!0);try{if(!h)return s("Invalid base URL format. URL must start with https://api.altan.ai/galaxia/hook/"),void u(!1);if(n.SAMPLE_TABLES){const t=Object.values(n.SAMPLE_TABLES),r=await(async e=>{try{const t=e.filter((e=>!N[e]));if(0===t.length)return{valid:!0};const r=t.join(","),a=`https://api.altan.ai/tables/table/ping?table_ids=${r}`,o=`ping_${r}`;if(A[o])return new Promise((e=>{const r=()=>{if(A[o])setTimeout(r,50);else{const r=t.every((e=>N[e]));e({valid:r})}};r()}));A[o]=!0;try{const e=await E.get(a);if(!e.data.all_valid){const t=e.data.invalid_tables||[];return(e.data.valid_tables||[]).forEach((e=>{N[e]=!0})),{valid:!1,invalidTables:t}}return t.forEach((e=>{N[e]=!0})),{valid:!0}}finally{A[o]=!1}}catch(e){return console.error("Table validation error:",e),{valid:!1}}})(t);if(!r.valid){let t;if(null===(e=r.invalidTables)||void 0===e?void 0:e.length){const e=Object.entries(n.SAMPLE_TABLES).filter((([e,t])=>{var a;return null===(a=r.invalidTables)||void 0===a?void 0:a.includes(t)})).map((([e])=>e)).join(", ");t=`Invalid tables: ${r.invalidTables.join(", ")} (table names: ${e})`}else t="One or more tables could not be found";return s(t),void u(!1)}}u(!1),p(!0)}catch(e){console.error("[DatabaseProvider] Validation error:",e),s(`Validation error: ${e instanceof Error?e.message:String(e)}`),u(!1)}})()}),[n,h]);const g=e.useMemo((()=>{if(d||c)return null;try{!function(e){for(const t of Object.values(e.SAMPLE_TABLES))if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t))throw new Error(`Table name "${t}" is not a valid UUID.`)}(n);const t=null!=y?y:(e=n.API_BASE_URL,o.create({baseURL:e})),a=r.configureStore({reducer:{tables:x},middleware:e=>e({thunk:{extraArgument:{api:t}}}).concat(i)});return a.dispatch(f(n)),a}catch(e){return console.error("Store creation error:",e),s(`Configuration error: ${e instanceof Error?e.message:String(e)}`),null}var e}),[n,i,d,y,c]),I=()=>{s(null)};return c?null:d?e.createElement(e.Fragment,null,e.createElement(w,{message:d,onClose:I,config:n}),e.createElement("div",null,"Unable to initialize database due to configuration errors.")):g?e.createElement(t.Provider,{store:g},l):e.createElement("div",null,"Failed to initialize database store.")}));C.displayName="DatabaseProvider";var k,R,$,L;function D(e,t){try{const r=e instanceof Date?e:new Date(String(e));return t?r.toLocaleString():r.toLocaleDateString()}catch(t){return String(e)}}function P(e){return Boolean(e)?"Yes":"No"}function F(e,t){try{const r=Number(e);return isNaN(r)?String(e):void 0!==t.decimals?r.toFixed(t.decimals):String(r)}catch(t){return String(e)}}function U(e,t){try{const r=Number(e);return isNaN(r)?String(e):new Intl.NumberFormat(t.locale||"en-US",{style:"currency",currency:t.currency||"USD"}).format(r)}catch(t){return String(e)}}function j(e,t){try{const r=Number(e);return isNaN(r)?String(e):`${(100*r).toFixed(t.decimals||0)}%`}catch(t){return String(e)}}function M(e){try{const t=Number(e);if(isNaN(t))return String(e);const r=Math.floor(t/36e5),a=Math.floor(t%36e5/6e4);return`${r}h ${a}m ${Math.floor(t%6e4/1e3)}s`}catch(t){return String(e)}}function _(e){return Array.isArray(e)?e.join(", "):String(e)}function B(e){try{return JSON.stringify(e,null,2)}catch(t){return String(e)}}exports.FieldType=void 0,(k=exports.FieldType||(exports.FieldType={})).SingleLineText="singleLineText",k.MultiLineText="multiLineText",k.Select="select",k.LongText="longText",k.Number="number",k.SingleSelect="singleSelect",k.MultiSelect="multiSelect",k.Date="date",k.DateTime="dateTime",k.Checkbox="checkbox",k.User="user",k.Attachment="attachment",k.Reference="reference",k.Email="email",k.Phone="phone",k.URL="url",k.Duration="duration",k.Rating="rating",k.Formula="formula",k.Rollup="rollup",k.Count="count",k.Lookup="lookup",k.Currency="currency",k.Percent="percent",k.ForeignKey="foreignKey",k.JSON="json",k.Trigger="trigger",r.configureStore({reducer:{tables:x},middleware:e=>e({thunk:{extraArgument:{}}})}),function(e){e.Local="Local",e.Friendly="Friendly",e.US="US",e.European="European",e.ISO="ISO"}(R||(R={})),function(e){e.TwelveHour="12 hour",e.TwentyFourHour="24 hour"}($||($={})),function(e){e.GMT_UTC="GMT/UTC",e.Local="local"}(L||(L={}));const z={formatFieldValue:function(e,t){if(null==e)return"";if(null==t?void 0:t.type)switch(t.type){case exports.FieldType.Date:return D(e,!1);case exports.FieldType.DateTime:return D(e,!0);case exports.FieldType.Checkbox:return P(e);case exports.FieldType.Number:return F(e,t);case exports.FieldType.Currency:return U(e,t);case exports.FieldType.Percent:return j(e,t);case exports.FieldType.Duration:return M(e);case exports.FieldType.MultiSelect:return _(e);case exports.FieldType.JSON:case exports.FieldType.User:case exports.FieldType.Attachment:return B(e);default:return String(e)}return e instanceof Date?D(e,!0):"object"==typeof e?JSON.stringify(e):String(e)},formatDateValue:D,formatBooleanValue:P,formatNumberValue:F,formatCurrencyValue:U,formatPercentValue:j,formatDurationValue:M,formatMultiSelectValue:_,formatJSONValue:B};exports.DatabaseProvider=C,exports.fieldHelpers=z,exports.useDatabase=function(r,a){const o=e.useRef(!0),n=t.useDispatch(),[m,f]=e.useState(null),p=e.useRef({}),x=t.useSelector((e=>((e,t)=>e.tables.tables.byName[t])(e,r))),w=t.useSelector((e=>((e,t)=>{const r=e.tables.tables.byName[t];if(!r)return null;const a=e.tables.records.byTableId[r];return{records:(null==a?void 0:a.items)||[],total:(null==a?void 0:a.total)||0,schema:e.tables.schemas.byTableId[r],initialized:e.tables.initialized[r],nextPageToken:null==a?void 0:a.nextPageToken,lastUpdated:null==a?void 0:a.lastUpdated}})(e,r))),E=t.useSelector((e=>"loading"===e.tables.loading.records)),N=t.useSelector((e=>"loading"===e.tables.loading.schemas)),A=t.useSelector((e=>e.tables.error)),{records:C,schema:k,initialized:R,lastUpdated:$}=e.useMemo((()=>({records:(null==w?void 0:w.records)||[],schema:(null==w?void 0:w.schema)||null,initialized:(null==w?void 0:w.initialized)||!1,lastUpdated:(null==w?void 0:w.lastUpdated)||null})),[w]);e.useEffect((()=>()=>{o.current=!1}),[]);const L=e.useMemo((()=>a||{limit:100}),[a]),D=e.useCallback((async(e,t)=>{try{const t=await n(e).unwrap();if(!o.current)return;return t}catch(e){return null==t||t(e),null}}),[n]);e.useEffect((()=>{if(!r||A)return;const e=`schema_${r}`,t=`records_${r}`;k||N||p.current[e]||(p.current[e]=!0,D(c({tableName:r})).finally((()=>{o.current&&(p.current[e]=!1)}))),R||E||p.current[t]||(p.current[t]=!0,D(l({tableName:r,queryParams:L})).finally((()=>{o.current&&(p.current[t]=!1)})))}),[r,k,L,D]);const P=e.useCallback((async(e={limit:20},t)=>{var a;if(!E){const n=await D(l({tableName:r,queryParams:e}),t);n&&o.current&&f(null!==(a=n.nextPageToken)&&void 0!==a?a:null)}}),[r,D,E]),F=e.useCallback((async(e,t)=>{if(!x)throw new Error(`Table ${r} not found`);const a=-Date.now(),o={id:a,...e};n(y({tableId:x,record:o}));try{const o=await D(i({tableName:r,record:e}),t);return o||n(v({tableId:x,tempId:a})),o}catch(e){throw n(v({tableId:x,tempId:a})),e}}),[r,x,D,n]),U=e.useCallback((async(e,t,a)=>{if(!x)throw new Error(`Table ${r} not found`);const o=C.find((t=>t.id===e));if(!o)throw new Error(`Record ${e} not found`);n(h({tableId:x,recordId:e,updates:t}));try{const l=await D(d({tableName:r,recordId:e,updates:t}),a);return null===l&&n(S({tableId:x,recordId:e,originalRecord:o})),l}catch(t){throw n(S({tableId:x,recordId:e,originalRecord:o})),t}}),[r,x,D,n,C]),j=e.useCallback((async(e,t)=>{if(!x)throw new Error(`Table ${r} not found`);const a=C.find((t=>t.id===e));if(!a)throw new Error(`Record ${e} not found`);n(g({tableId:x,recordId:e}));try{await D(s({tableName:r,recordId:e}),t)}catch(e){throw n(y({tableId:x,record:a})),e}}),[r,x,D,n,C]),M=e.useCallback((async(e,t)=>{if(!x)throw new Error(`Table ${r} not found`);const a=-Date.now(),o=e.map(((e,t)=>({id:a-t,...e})));n(I({tableId:x,records:o}));try{const a=await D(u({tableName:r,records:e}),t);return a||n(T({tableId:x,recordIds:o.map((e=>e.id))})),a}catch(e){throw n(T({tableId:x,recordIds:o.map((e=>e.id))})),e}}),[r,x,D,n]),_=e.useCallback((async(e,t)=>{if(!x)throw new Error(`Table ${r} not found`);const a=C.filter((t=>e.includes(t.id)));if(a.length!==e.length)throw new Error("Some records not found");n(T({tableId:x,recordIds:e}));try{await D(b({tableName:r,recordIds:e}),t)}catch(e){throw n(I({tableId:x,records:a})),e}}),[r,x,D,n,C]);return e.useMemo((()=>({records:C,schema:k,isLoading:E,schemaLoading:N,error:A,nextPageToken:m,lastUpdated:$,refresh:P,fetchNextPage:async e=>{m&&!E&&await P({pageToken:m,limit:20},e)},addRecord:F,modifyRecord:U,removeRecord:j,addRecords:M,removeRecords:_})),[C,k,E,N,A,m,$,P,r,n,F,U,j,M,_])};
//# sourceMappingURL=index.js.map
